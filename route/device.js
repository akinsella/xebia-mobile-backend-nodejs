// Generated by CoffeeScript 1.6.3
var Device, apn, create, findById, list, mapDevice, register, removeById, utils, _;

utils = require('../lib/utils');

_ = require('underscore')._;

apn = require('apn');

Device = require("../model/device");

create = function(req, res) {
  var device;
  device = new Device({
    udid: req.body.udid,
    token: req.body.token,
    deviceModel: req.body.deviceModel,
    systemVersion: req.body.systemVersion
  });
  return device.save(function(err, device) {
    if (err) {
      return utils.responseData(500, "Could not save device", req.body, {
        req: req,
        res: res
      });
    } else {
      return utils.responseData(201, "Created", mapDevice(device), {
        req: req,
        res: res
      });
    }
  });
};

register = function(req, res) {
  var query;
  query = {
    udid: req.body.udid,
    token: req.body.token
  };
  return Device.findOne(query, function(err, device) {
    if (err) {
      return utils.responseData(500, "Could not check device is already registered", void 0, {
        req: req,
        res: res
      });
    } else if (device) {
      device.deviceModel = req.body.deviceModel;
      device.systemVersion = req.body.systemVersion;
      return Device.update(query, {
        deviceModel: req.body.deviceModel,
        systemVersion: req.body.systemVersion
      }, {
        upsert: true
      }, function(err, numberAffected, raw) {
        if (err) {
          return utils.responseData(500, "Could not check device is already registered", void 0, {
            req: req,
            res: res
          });
        } else {
          return utils.responseData(200, "Device already registered was updated", mapDevice(device), {
            req: req,
            res: res
          });
        }
      });
    } else {
      device = new Device({
        udid: req.body.udid,
        token: req.body.token,
        deviceModel: req.body.deviceModel,
        systemVersion: req.body.systemVersion
      });
      return device.save(function(err, device) {
        if (err) {
          return utils.responseData(500, "Could not save device", req.body, {
            req: req,
            res: res
          });
        } else {
          return utils.responseData(201, "Created", mapDevice(device), {
            req: req,
            res: res
          });
        }
      });
    }
  });
};

list = function(req, res) {
  return Device.find({}, function(err, devices) {
    if (err) {
      return utils.responseData(500, "Could not get device list", void 0, {
        req: req,
        res: res
      });
    } else {
      return utils.responseData(200, void 0, devices.map(mapDevice), {
        req: req,
        res: res
      });
    }
  });
};

findById = function(req, res) {
  return Device.findOne({
    id: req.params.id
  }, function(err, device) {
    if (err) {
      return utils.responseData(500, "Could not get device", void 0, {
        req: req,
        res: res
      });
    } else if (!device) {
      return utils.responseData(404, "Not Found", void 0, {
        req: req,
        res: res
      });
    } else {
      return utils.responseData(200, void 0, mapDevice(device), {
        req: req,
        res: res
      });
    }
  });
};

removeById = function(req, res) {
  return Device.findOneAndRemove({
    id: req.params.id
  }, function(err, device) {
    if (device) {
      return utils.responseData(204, void 0, mapDevice(device), {
        req: req,
        res: res
      });
    } else {
      return utils.responseData(404, "Not Found", void 0, {
        req: req,
        res: res
      });
    }
  });
};

mapDevice = function(device) {
  return {
    id: device.id,
    token: device.token,
    udid: device.udid,
    deviceModel: device.deviceModel,
    systemVersion: device.systemVersion
  };
};

module.exports = {
  register: register,
  list: list,
  findById: findById,
  create: create,
  removeById: removeById
};

/*
//@ sourceMappingURL=device.map
*/
