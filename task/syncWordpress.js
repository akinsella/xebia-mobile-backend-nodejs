// Generated by CoffeeScript 1.6.3
var Author, Category, News, Tag, apns, async, config, db, moment, processWordpressAuthors, processWordpressCategories, processWordpressRecentBlogPosts, processWordpressTags, request, synchronize, synchronizeWordpressAuthor, synchronizeWordpressCategory, synchronizeWordpressNews, synchronizeWordpressTag, utils, _;

async = require('async');

moment = require("moment");

_ = require('underscore')._;

request = require("request");

config = require("../conf/config");

utils = require('../lib/utils');

db = require("../db");

apns = require("../lib/apns");

News = require("../model/news");

Tag = require("../model/tag");

Category = require("../model/category");

Author = require("../model/author");

synchronize = function() {
  var callback;
  callback = function(err, results) {
    if (err) {
      return console.log("Wordpress Synchronization ended with error: " + err.message + " - Error: " + err);
    } else {
      return console.log("Wordpress Synchronization ended with success !");
    }
  };
  if (config.feature.stopWatch) {
    callback = utils.stopWatchCallbak(callback);
  }
  console.log("Start synchronizing Wordpress data ...");
  return async.parallel([processWordpressTags, processWordpressCategories, processWordpressAuthors, processWordpressRecentBlogPosts], callback);
};

processWordpressTags = function(callback) {
  console.log("Start synchronizing Wordpress tags ...");
  return request.get({
    url: "http://blog.xebia.fr/wp-json-api/get_tag_index",
    json: true
  }, function(error, data, response) {
    return async.map(response.tags, synchronizeWordpressTag, function(err, results) {
      return console.log("Synchronized " + results.length + " Wordpress tags");
    });
  });
};

processWordpressCategories = function(callback) {
  console.log("Start synchronizing Wordpress categories ...");
  return request.get({
    url: "http://blog.xebia.fr/wp-json-api/get_category_index",
    json: true
  }, function(error, data, response) {
    return async.map(response.categories, synchronizeWordpressCategory, function(err, results) {
      return console.log("Synchronized " + results.length + " Wordpress categories");
    });
  });
};

processWordpressAuthors = function(callback) {
  console.log("Start synchronizing Wordpress authors ...");
  return request.get({
    url: "http://blog.xebia.fr/wp-json-api/get_author_index",
    json: true
  }, function(error, data, response) {
    return async.map(response.authors, synchronizeWordpressAuthor, function(err, results) {
      return console.log("Synchronized " + results.length + " Wordpress authors");
    });
  });
};

processWordpressRecentBlogPosts = function(callback) {
  console.log("Start synchronizing Wordpress blog posts ...");
  return request.get({
    url: "http://blog.xebia.fr/wp-json-api/get_recent_posts?count=50",
    json: true
  }, function(error, data, response) {
    return async.map(response.posts, synchronizeWordpressNews, function(err, results) {
      return console.log("Synchronized " + results.length + " Wordpress posts");
    });
  });
};

synchronizeWordpressTag = function(tag, callback) {
  return Tag.findOne({
    id: tag.id
  }, function(err, tagFound) {
    var tagEntry;
    if (err) {
      return callback(err);
    } else if (!tagFound) {
      tagEntry = new Tag(tag);
      return tagEntry.save(function(err) {
        callback(err, tagEntry);
        return console.log("New tag synchronised: " + tagEntry.title);
      });
    } else {
      return callback(err, tagFound);
    }
  });
};

synchronizeWordpressCategory = function(category, callback) {
  return Category.findOne({
    id: category.id
  }, function(err, categoryFound) {
    var categoryEntry;
    if (err) {
      return callback(err);
    } else if (!categoryFound) {
      categoryEntry = new Category(category);
      return categoryEntry.save(function(err) {
        callback(err, categoryEntryEntry);
        return console.log("New category synchronised: " + categoryEntryEntry.title);
      });
    } else {
      return callback(err, categoryFound);
    }
  });
};

synchronizeWordpressAuthor = function(author, callback) {
  return Author.findOne({
    id: author.id
  }, function(err, authorFound) {
    var authorEntry;
    if (err) {
      return callback(err);
    } else if (!authorFound) {
      authorEntry = new Author(author);
      return authorEntry.save(function(err) {
        callback(err, authorEntry);
        return console.log("New author synchronised: " + authorEntry.name);
      });
    } else {
      return callback(err, authorFound);
    }
  });
};

synchronizeWordpressNews = function(post, callback) {
  return News.findOne({
    type: 'wordpress',
    typeId: post.id
  }, function(err, news) {
    var newsEntry, _ref, _ref1;
    if (err) {
      return callback(err);
    } else if (!news) {
      newsEntry = new News({
        content: post.excerpt,
        draft: false,
        imageUrl: (post != null ? post.attachments : void 0) && post.attachments.length > 0 ? (post != null ? (_ref = post.attachments[0].images) != null ? (_ref1 = _ref.full) != null ? _ref1.url : void 0 : void 0 : void 0) || "" : "",
        publicationDate: post.date,
        targetUrl: post.url,
        title: post.title_plain,
        author: post.author.name,
        type: "wordpress",
        typeId: post.id
      });
      return newsEntry.save(function(err) {
        callback(err, newsEntry);
        return apns.pushToAll("New blog post: " + newsEntry.title, function() {
          return console.log("Pushed Notification for blog post: '" + newsEntry.title + "'");
        });
      });
    } else {
      return callback(err, news);
    }
  });
};

module.exports = {
  synchronize: synchronize
};

/*
//@ sourceMappingURL=syncWordpress.map
*/
