// Generated by CoffeeScript 1.6.3
var News, apns, async, config, db, moment, processEventBriteEntries, request, synchronize, synchronizeEventNews, utils, _;

utils = require('../lib/utils');

async = require('async');

_ = require('underscore')._;

News = require("../model/news");

db = require("../db");

moment = require("moment");

config = require("../conf/config");

request = require("request");

apns = require("../lib/apns");

synchronize = function() {
  var callback;
  callback = function(err, news) {
    if (err) {
      return console.log("EventBrite Synchronization ended with error: " + err.message + " - Error: " + err);
    } else {
      return console.log("EventBrite Synchronization ended with success ! (" + news.length + " events synchronized)");
    }
  };
  if (config.feature.stopWatch) {
    callback = utils.stopWatchCallbak(callback);
  }
  console.log("Start synchronizing EventBrite entries ...");
  return processEventBriteEntries(callback);
};

processEventBriteEntries = function(callback) {
  var apiKey;
  apiKey = process.env["EVENTBRITE_AUTH_KEY"];
  "https://www.eventbrite.com/json/organizer_list_events?app_key=" + apiKey + "&id=1627902102";
  return request.get({
    url: "https://www.eventbrite.com/json/organizer_list_events?app_key=" + apiKey + "&id=1627902102",
    json: true
  }, function(error, data, response) {
    var events;
    events = _(response.events).pluck("event");
    events = _(events).sortBy(function(event) {
      return event.start_date;
    });
    events = _(events).filter(function(event) {
      return event.status === "Live" || event.status === "Completed";
    });
    events = _(events).reverse();
    _(events).each(function(event) {
      return event;
    });
    return async.map(events, synchronizeEventNews, callback);
  });
};

synchronizeEventNews = function(event, callback) {
  return News.findOne({
    type: 'eventbrite',
    typeId: event.id
  }, function(err, news) {
    var newsEntry;
    if (err) {
      return callback(err);
    } else if (!news) {
      event.descriptionPlainText = event.description;
      if (event.descriptionPlainText) {
        event.descriptionPlainText = event.descriptionPlainText.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>?/gi, '');
        event.descriptionPlainText = event.descriptionPlainText.replace(/<!--(.*?)-->/g, '');
        event.descriptionPlainText = event.descriptionPlainText.replace(/\n\s*\n/g, '\n');
      }
      newsEntry = new News({
        content: event.descriptionPlainText,
        draft: false,
        imageUrl: "",
        publicationDate: event.created,
        targetUrl: event.url,
        title: event.title,
        author: event.organizer.name,
        type: "eventbrite",
        typeId: event.id
      });
      return newsEntry.save(function(err) {
        callback(err, newsEntry.id);
        return apns.pushToAll("Nouvel événement: " + newsEntry.title, function() {
          return console.log("Pushed notification for new event: " + newsEntry.title);
        });
      });
    } else {
      return callback(err, news.id);
    }
  });
};

module.exports = {
  synchronize: synchronize
};

/*
//@ sourceMappingURL=syncEventBriteNews.map
*/
